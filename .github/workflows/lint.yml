name: Lint

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

jobs:
  yaml-lint:
    name: YAML Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run yamllint
        uses: actionshub/yamllint@v1.8.3
        with:
          file_or_dir: .
          config_file: .yamllint
          strict: false

  actionlint:
    name: GitHub Actions Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run actionlint
        uses: reviewdog/action-actionlint@v1
        with:
          fail_on_error: true
          filter_mode: nofilter
          level: error

  markdown-lint:
    name: Markdown Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run markdownlint
        uses: DavidAnson/markdownlint-cli2-action@v18
        with:
          globs: |
            **/*.md
            !**/node_modules/**
          config: .markdownlint.json

  typescript-lint-ai-triage:
    name: TypeScript Lint (ai-triage)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install root dependencies
        run: npm ci

      - name: Install ai-triage dependencies
        working-directory: ai-triage
        run: npm ci

      - name: Run ESLint
        working-directory: ai-triage
        run: npm run lint

      - name: Check formatting
        working-directory: ai-triage
        run: npx prettier --check '**/*.ts'

  typescript-lint-copilot:
    name: TypeScript Lint (copilot-subtask-manager)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install root dependencies
        run: npm ci

      - name: Install copilot-subtask-manager dependencies
        working-directory: copilot-subtask-manager
        run: npm ci

      - name: Run ESLint
        working-directory: copilot-subtask-manager
        run: npm run lint

      - name: Check formatting
        working-directory: copilot-subtask-manager
        run: npx prettier --check '**/*.ts'

  lint-summary:
    name: Lint Summary
    runs-on: ubuntu-latest
    needs:
      [
        yaml-lint,
        actionlint,
        markdown-lint,
        typescript-lint-ai-triage,
        typescript-lint-copilot,
      ]
    if: always()

    steps:
      - name: Check Results
        run: |
          if [[ "${{ needs.yaml-lint.result }}" != "success" ]] || \
             [[ "${{ needs.actionlint.result }}" != "success" ]] || \
             [[ "${{ needs.markdown-lint.result }}" != "success" ]] || \
             [[ "${{ needs.typescript-lint-ai-triage.result }}" != "success" ]] || \
             [[ "${{ needs.typescript-lint-copilot.result }}" != "success" ]]; then
            echo "❌ One or more linting jobs failed"
            exit 1
          else
            echo "✅ All linting checks passed"
          fi
