name: Integration Tests - AI Triage MCP

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to test (leave empty for current branch)'
        required: false
        default: ''
  pull_request:
    paths:
      - 'ai-triage-mcp/**'
      - '.github/workflows/ai-triage-mcp-poc.yml'
      - '.github/workflows/test-ai-triage-mcp.yml'
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday at midnight UTC

permissions:
  contents: read
  issues: write
  models: read

jobs:
  setup:
    name: Setup Test Environment
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure automated-test label exists
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if label exists
          if ! gh label list --json name --jq '.[].name' | grep -q "^automated-test$"; then
            echo "Creating automated-test label..."
            gh label create "automated-test" \
              --description "Issues created by automated integration tests" \
              --color "e99695"
            echo "✅ Label created"
          else
            echo "✅ Label already exists"
          fi

  test-basic-triage:
    needs: setup
    name: Test Basic Triage
    runs-on: ubuntu-latest

    outputs:
      issue_number: ${{ steps.create-issue.outputs.issue_number }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: Create test issue
        id: create-issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          issue_url=$(gh issue create \
            --title "[Test] Minor documentation typo" \
            --body "Fix typo in README: change 'teh' to 'the' on line 42" \
            --label "automated-test")

          issue_number="${issue_url##*/}"
          echo "issue_number=$issue_number" >> "$GITHUB_OUTPUT"
          echo "Created test issue #$issue_number"

      - name: Trigger triage action
        uses: ./ai-triage-mcp
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ steps.create-issue.outputs.issue_number }}

      - name: Wait for triage to complete
        run: sleep 5

      - name: Verify labels applied
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          issue_number="${{ steps.create-issue.outputs.issue_number }}"

          # Get issue labels
          labels=$(gh issue view "$issue_number" --json labels --jq '.labels[].name')

          echo "Labels applied: $labels"

          # Check for type: label
          if ! echo "$labels" | grep -q "type:"; then
            echo "❌ Missing type: label"
            exit 1
          fi

          # Check for priority: label
          if ! echo "$labels" | grep -q "priority:"; then
            echo "❌ Missing priority: label"
            exit 1
          fi

          echo "✅ Labels verified successfully"

      - name: Verify triage comment posted
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          issue_number="${{ steps.create-issue.outputs.issue_number }}"

          # Get comments
          comments=$(gh issue view "$issue_number" --json comments --jq '.comments[].body')

          # Check for triage comment
          if ! echo "$comments" | grep -q "AI Triage Analysis"; then
            echo "❌ Triage comment not found"
            exit 1
          fi

          # Check for required fields in comment
          if ! echo "$comments" | grep -q "Category:"; then
            echo "❌ Missing Category in triage comment"
            exit 1
          fi

          if ! echo "$comments" | grep -q "Priority:"; then
            echo "❌ Missing Priority in triage comment"
            exit 1
          fi

          if ! echo "$comments" | grep -q "Complexity:"; then
            echo "❌ Missing Complexity in triage comment"
            exit 1
          fi

          echo "✅ Triage comment verified successfully"

      - name: Verify subtask behavior
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          issue_number="${{ steps.create-issue.outputs.issue_number }}"

          # Check issue body for subtasks section
          body=$(gh issue view "$issue_number" --json body --jq '.body')

          if echo "$body" | grep -q "## Subtasks"; then
            echo "⚠️  AI decided to create subtasks (this is acceptable)"
            echo "The AI determined this issue warrants breakdown despite being marked as 'simple'"
          else
            echo "✅ No subtasks created as expected"
          fi
          # Don't fail the test either way

  test-subtask-creation:
    name: Test Subtask Creation
    needs: setup
    runs-on: ubuntu-latest

    outputs:
      issue_number: ${{ steps.create-issue.outputs.issue_number }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: Create complex test issue
        id: create-issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          issue_url=$(gh issue create \
            --title "[Test] Complex feature requiring multiple implementation steps" \
            --body "We need to implement a new user profile management system. This includes:

          1. Database schema updates for user profiles
          2. Backend API implementation for CRUD operations
          3. Frontend UI components for profile editing
          4. Integration tests for profile workflows
          5. Documentation updates for API endpoints
          6. Performance optimization and caching" \
            --label "automated-test")

          issue_number="${issue_url##*/}"
          echo "issue_number=$issue_number" >> "$GITHUB_OUTPUT"
          echo "Created complex test issue #$issue_number"

      - name: Trigger triage action
        uses: ./ai-triage-mcp
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ steps.create-issue.outputs.issue_number }}

      - name: Wait for triage to complete
        run: sleep 5

      - name: Verify parent issue has subtasks section
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          issue_number="${{ steps.create-issue.outputs.issue_number }}"

          # Get issue body
          body=$(gh issue view "$issue_number" --json body --jq '.body')

          # Check for subtasks section
          if ! echo "$body" | grep -q "## Subtasks"; then
            echo "⚠️  Subtasks section not found (AI may have decided issue is not complex enough)"
            echo "This is acceptable - not all issues trigger subtask creation"
            exit 0
          fi

          echo "✅ Subtasks section found in parent issue"

      - name: Verify subtask issues created
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          issue_number="${{ steps.create-issue.outputs.issue_number }}"

          # Get parent issue body and extract subtask numbers from tasklist
          body=$(gh issue view "$issue_number" --json body --jq '.body')

          # Extract issue numbers from tasklist (format: - [ ] #123)
          subtasks=$(echo "$body" | grep -oP '(?<=- \[ \] #)\d+' | tr '\n' ' ')

          if [ -z "$subtasks" ]; then
            echo "⚠️  No subtask issues found in parent issue tasklist"
            echo "This is acceptable - AI may have decided issue doesn't need subtasks"
            exit 0
          fi

          echo "✅ Found subtask issues: $subtasks"

          # Verify subtasks have proper labels (inherited from parent)
          for subtask in $subtasks; do
            labels=$(gh issue view "$subtask" --json labels --jq '.labels[].name')

            if ! echo "$labels" | grep -q "automated-test"; then
              echo "❌ Subtask #$subtask missing 'automated-test' label"
              exit 1
            fi

            echo "✅ Subtask #$subtask has correct labels"
          done

  test-error-handling:
    name: Test Error Handling
    needs: setup
    runs-on: ubuntu-latest

    outputs:
      issue_number: ${{ steps.create-issue.outputs.issue_number }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: Create test issue with empty body
        id: create-issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          issue_url=$(gh issue create \
            --title "[Test] Issue with minimal content" \
            --body "Test" \
            --label "automated-test")

          issue_number="${issue_url##*/}"
          echo "issue_number=$issue_number" >> "$GITHUB_OUTPUT"
          echo "Created minimal test issue #$issue_number"

      - name: Trigger triage action
        id: triage
        continue-on-error: true
        uses: ./ai-triage-mcp
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ steps.create-issue.outputs.issue_number }}

      - name: Wait for action to complete
        run: sleep 5

      - name: Verify action handled edge case
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          issue_number="${{ steps.create-issue.outputs.issue_number }}"

          # Get issue details
          labels=$(gh issue view "$issue_number" --json labels --jq '.labels[].name')
          comments=$(gh issue view "$issue_number" --json comments --jq '.comments[].body')

          # Either the action succeeded and added labels, or it failed gracefully with error comment
          if echo "$labels" | grep -q "type:"; then
            echo "✅ Action succeeded - labels applied"
          elif echo "$comments" | grep -q "AI Triage Failed"; then
            echo "✅ Action failed gracefully - error comment posted"
          else
            echo "⚠️  No clear success or error indication, but this is acceptable for minimal content"
          fi

  cleanup-test-issues:
    name: Cleanup Test Issues
    runs-on: ubuntu-latest
    needs: [test-basic-triage, test-subtask-creation, test-error-handling]
    if: always()

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Delete all test issues
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Cleaning up test issues..."

          # Get all issues with automated-test label (both open and closed)
          issues=$(gh issue list --label "automated-test" --state all --json number --jq '.[].number' || echo "")

          if [ -z "$issues" ]; then
            echo "No test issues to clean up"
            exit 0
          fi

          # Delete each issue, continue on error
          for issue in $issues; do
            if gh issue delete "$issue" --yes 2>/dev/null; then
              echo "✅ Deleted test issue #$issue"
            else
              echo "⚠️  Could not delete issue #$issue (may already be deleted)"
            fi
          done

          echo "✅ Cleanup complete"

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test-basic-triage, test-subtask-creation, test-error-handling, cleanup-test-issues]
    if: always()

    steps:
      - name: Check test results
        run: |
          echo "## Test Results Summary"
          echo ""
          echo "Basic Triage: ${{ needs.test-basic-triage.result }}"
          echo "Subtask Creation: ${{ needs.test-subtask-creation.result }}"
          echo "Error Handling: ${{ needs.test-error-handling.result }}"
          echo "Cleanup: ${{ needs.cleanup-test-issues.result }}"
          echo ""

          if [[ "${{ needs.test-basic-triage.result }}" != "success" ]] || \
             [[ "${{ needs.test-subtask-creation.result }}" != "success" ]] || \
             [[ "${{ needs.test-error-handling.result }}" != "success" ]]; then
            echo "❌ One or more tests failed"
            exit 1
          else
            echo "✅ All tests passed successfully"
          fi
